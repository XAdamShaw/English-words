<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>一万英语高频词</title>
  <style>
    :root{
      --accent: #246bfd;
      --muted: #6b7280;
      --card-bg: rgba(255,255,255,0.06);
      --card-radius: 12px;
      --gap: 16px;
      --star-yellow: #fbbf24;
      --text-light: #fff;
      --text-dark: #0f172a;
    }

    /* Reset + base */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(135deg,#4A90E2,#9013FE);background-attachment:fixed;color:var(--text-light);transition:background .35s,color .35s}

    .wrap{max-width:1100px;margin:20px auto;padding:12px}
    
    /* Fixed header area */
    header{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:100;
      background:rgba(0,0,0,0.25);
      backdrop-filter:blur(10px);
      padding:12px 16px;
      box-shadow:0 2px 10px rgba(0,0,0,0.1);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      transition:opacity 0.3s ease, transform 0.3s ease;
    }
    
    header.hidden{
      opacity:0;
      transform:translateY(-100%);
      pointer-events:none;
    }
    
    /* Fixed scroll control area */
    .scroll-control{
      position:fixed;
      top:56px;
      left:0;
      right:0;
      z-index:99;
      background:rgba(0,0,0,0.2);
      backdrop-filter:blur(8px);
      padding:10px 16px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      max-width:100%;
      transition:opacity 0.3s ease, transform 0.3s ease;
    }
    
    .scroll-control.hidden{
      opacity:0;
      transform:translateY(-100%);
      pointer-events:none;
    }
    
    .scroll-control .slider-wrap{
      flex:1;
      max-width:500px;
      min-width:200px;
    }
    
    .scroll-control input[type=range]{
      width:100%;
      height:8px;
      border-radius:4px;
      background:rgba(255,255,255,0.2);
      outline:none;
      cursor:pointer;
    }
    
    .scroll-control input[type=range]:disabled{
      cursor:not-allowed;
      opacity:0.4;
    }
    
    .scroll-control .right-controls{
      display:flex;
      align-items:center;
      gap:8px;
      margin-right:24px;
    }
    
    .scroll-control .row-info{
      font-size:14px;
      color:var(--text-light);
      white-space:nowrap;
      min-width:180px;
      margin-right:12px;
    }
    
    .scroll-control .jump-input{
      width:80px;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.1);
      color:var(--text-light);
      font-size:14px;
      text-align:center;
    }
    
    .scroll-control .jump-input:disabled{
      cursor:not-allowed;
      opacity:0.4;
    }
    
    .scroll-control .jump-input.error{
      border-color:#ef4444;
      box-shadow:0 0 0 2px rgba(239,68,68,0.2);
    }
    
    .scroll-control .go-btn{
      background:var(--accent);
      color:#fff;
      border:none;
      padding:6px 16px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
    }
    
    .scroll-control .go-btn:disabled{
      cursor:not-allowed;
      opacity:0.4;
      background:#6b7280;
    }
    
    /* Hide/Show toggle button */
    .toggle-view-btn{
      background:rgba(255,255,255,0.15);
      color:var(--text-light);
      border:1px solid rgba(255,255,255,0.2);
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
      font-size:13px;
      transition:all 0.2s ease;
      white-space:nowrap;
    }
    
    .toggle-view-btn:hover{
      background:rgba(255,255,255,0.25);
      opacity:0.9;
    }
    
    /* Floating toggle button (when views are hidden) */
    .floating-toggle-btn{
      position:fixed;
      top:20px;
      right:20px;
      width:40px;
      height:40px;
      border-radius:50%;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(8px);
      border:2px solid rgba(255,255,255,0.3);
      color:#fff;
      font-size:20px;
      display:none;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      z-index:200;
      opacity:0.6;
      transition:opacity 0.3s ease, transform 0.3s ease;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    
    .floating-toggle-btn:hover{
      opacity:0.9;
      transform:scale(1.05);
    }
    
    .floating-toggle-btn.visible{
      display:flex;
    }
    
    /* Adjust main content to account for fixed headers */
    main{margin-top:120px;transition:margin-top 0.3s ease}
    main.expanded{margin-top:20px}

    /* Left controls */
    .left-controls{display:flex;gap:8px;align-items:center}
    .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
    .ghost{background:transparent;color:var(--text-light);border:1px solid rgba(255,255,255,0.12)}
    input[type=file]{display:none}

    /* Background selector (color blocks) */
    .bg-picker{display:flex;gap:8px;align-items:center}
    .bg-swatch{width:40px;height:32px;border-radius:8px;cursor:pointer;border:2px solid rgba(255,255,255,0.06)}
    .bg-swatch:focus{outline:3px solid rgba(0,0,0,0.12)}

    /* History modal */
    .history-wrap{position:relative}
    .history-list{position:fixed;background:var(--card-bg);backdrop-filter:blur(6px);border-radius:10px;padding:12px;width:max-content;min-width:320px;max-width:calc(100vw - 200px);max-height:500px;overflow-y:auto;box-shadow:0 10px 30px rgba(2,6,23,0.35);z-index:50;color:inherit}
    .history-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px}
    .history-item .name{flex:1;word-break:break-word;padding-right:12px}
    .history-item:hover{background:rgba(255,255,255,0.04)}

    /* Main area */
    .cards{display:flex;flex-direction:column;gap:20px}

    .card{
      display:grid;
      grid-template-columns:1fr 120px;
      gap:12px;align-items:start;padding:14px;border-radius:var(--card-radius);background:var(--card-bg);box-shadow:0 6px 18px rgba(2,6,23,0.18);transition:transform .12s
    }
    .card:hover{transform:translateY(-4px)}
    .card-body{display:flex;flex-direction:column;gap:8px}
    .field{white-space:pre-wrap;word-break:break-word;font-size:15px;line-height:1.45;color:inherit}
    .row-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:4px}
    .row-number{font-size:13px;color:var(--muted);font-weight:600}
    .col-first{font-size:11px;color:var(--muted);font-weight:500;flex:1;text-align:right}
    .cols-23{white-space:pre;font-size:15px;line-height:1.45;color:inherit}

    /* right column: stars + freq */
    .card-side{display:flex;flex-direction:column;align-items:center;gap:12px}
    .stars{display:flex;gap:6px}
    .star{font-size:20px;cursor:pointer;user-select:none;color:rgba(255,255,255,0.45)}
    .star.active{color:var(--star-yellow);opacity:1}

    .freq{font-size:13px;color:var(--muted);align-self:flex-start}

    .card-actions{display:flex;gap:8px;align-items:center;width:100%;justify-content:flex-start}
    .reset{background:transparent;border:1px solid rgba(255,255,255,0.12);padding:6px 8px;border-radius:6px;color:inherit;font-size:13px;cursor:pointer}

    /* Empty state */
    .empty{padding:40px;text-align:center;color:var(--muted)}

    /* Responsive */
    @media(max-width:820px){
      .card{grid-template-columns:1fr 96px}
      .history-list{min-width:320px}
      .scroll-control{padding:8px 12px}
      .scroll-control .slider-wrap{min-width:150px;max-width:300px}
      .scroll-control .right-controls{margin-right:12px}
      .scroll-control .row-info{min-width:150px;font-size:13px;margin-right:8px}
      .scroll-control .jump-input{width:70px}
      .toggle-view-btn{font-size:12px;padding:5px 10px}
    }
    @media(max-width:520px){
      header{flex-direction:column;align-items:stretch;gap:8px}
      .card{grid-template-columns:1fr 88px}
      .card-side{align-items:flex-end}
      .scroll-control{flex-direction:column;gap:10px;padding:10px 12px}
      .scroll-control .slider-wrap{width:100%;max-width:100%;min-width:100%}
      .scroll-control .right-controls{width:100%;justify-content:space-between;margin-right:0}
      .scroll-control .row-info{font-size:12px;min-width:auto;margin-right:8px;flex:1}
      .scroll-control .jump-input{width:60px}
      main{margin-top:160px}
      main.expanded{margin-top:20px}
      .toggle-view-btn{align-self:flex-end;font-size:11px;padding:4px 8px}
      .bg-picker{flex-wrap:wrap}
    }

    /* utility */
    .small{font-size:13px;color:var(--muted)}
    .top-row{display:flex;align-items:center;gap:12px}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="left-controls">
        <label class="btn">选择 CSV
          <input id="fileInput" type="file" accept=".csv,text/csv" />
        </label>

        <div class="history-wrap">
          <button id="historyBtn" class="ghost">CSV 历史 ▾</button>
          <div id="historyList" class="history-list" style="display:none"></div>
        </div>
      </div>

      <div class="bg-picker" title="切换背景（点击色块）">
        <div class="small">背景：</div>
        <div class="bg-swatch" data-index="0" id="sw0" style="background:linear-gradient(135deg,#4A90E2,#9013FE)"></div>
        <div class="bg-swatch" data-index="1" id="sw1" style="background:#ffffff;border:1px solid #e5e7eb"></div>
        <div class="bg-swatch" data-index="2" id="sw2" style="background:#e5e7eb"></div>
        <div class="bg-swatch" data-index="3" id="sw3" style="background:#0f172a"></div>
      </div>
      
      <button id="toggleViewBtn" class="toggle-view-btn">Hide</button>
    </header>
    
    <button id="floatingToggleBtn" class="floating-toggle-btn" title="显示菜单">☰</button>

    <div class="scroll-control">
      <div class="slider-wrap">
        <input type="range" id="scrollSlider" min="1" max="1" value="1" disabled />
      </div>
      <div class="right-controls">
        <div class="row-info" id="rowInfo">当前显示第 0 条 / 共 0 条</div>
        <input type="number" id="jumpInput" class="jump-input" min="1" placeholder="行号" disabled />
        <button id="goBtn" class="go-btn" disabled>Go</button>
      </div>
    </div>

    <main>
      <div id="cards" class="cards">
        <div id="empty" class="empty">尚未加载任何 CSV。点击"选择 CSV"上传文件，或者从历史中选择已上传的文件。</div>
      </div>
    </main>
  </div>

<script>
  /* ---------- Storage helpers ---------- */
  const HISTORY_KEY = 'csv_history_v2';
  function saveJSON(k,v){localStorage.setItem(k,JSON.stringify(v));}
  function loadJSON(k,def=null){try{const s=localStorage.getItem(k);return s?JSON.parse(s):def;}catch(e){return def}}

  /* ---------- CSV parsing (robust) ---------- */
  function parseCSV(text){
    // RFC-style simple parser handling quoted fields
    const rows=[];
    let cur=''; let row=[]; let inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i];
      if(inQ){
        if(ch==='"'){
          if(text[i+1]==='"'){cur+='"'; i++;} else {inQ=false}
        } else cur+=ch;
      } else {
        if(ch==='"'){inQ=true;}
        else if(ch===','){row.push(cur); cur='';}
        else if(ch==='\r'){continue;}
        else if(ch==='\n'){row.push(cur); rows.push(row); row=[]; cur='';}
        else cur+=ch;
      }
    }
    if(cur!=='' || row.length>0){row.push(cur); rows.push(row)}
    // remove empty trailing rows
    return rows.filter(r=>r.some(c=>c!==''));
  }

  function rowId(filename,row){ // stable id per row content
    const s = JSON.stringify(row);
    let h = 2166136261 >>> 0;
    for(let i=0;i<s.length;i++) h = (h ^ s.charCodeAt(i)) * 16777619 >>> 0;
    return filename + '_r_' + h.toString(16);
  }

  /* ---------- App state ---------- */
  let currentFile = null;
  let rows = []; // array of arrays
  let ratings = {}; // id -> 0..5

  const fileInput = document.getElementById('fileInput');
  const cardsEl = document.getElementById('cards');
  const emptyEl = document.getElementById('empty');
  const historyBtn = document.getElementById('historyBtn');
  const historyList = document.getElementById('historyList');
  
  // Scroll control elements
  const scrollSlider = document.getElementById('scrollSlider');
  const rowInfo = document.getElementById('rowInfo');
  const jumpInput = document.getElementById('jumpInput');
  const goBtn = document.getElementById('goBtn');
  
  let currentRowNum = 1; // Current displayed row number
  let totalRows = 0; // Total data rows (excluding header)
  let scrollAnimationId = null; // For interrupting ongoing scroll animations
  let isViewsHidden = false; // Track visibility state of fixed views

  /* ---------- Toggle fixed views visibility ---------- */
  const headerEl = document.querySelector('header');
  const scrollControlEl = document.querySelector('.scroll-control');
  const mainEl = document.querySelector('main');
  const toggleViewBtn = document.getElementById('toggleViewBtn');
  const floatingToggleBtn = document.getElementById('floatingToggleBtn');
  
  function toggleFixedViews(){
    const startTime = performance.now();
    
    // Check if elements exist
    if(!headerEl || !scrollControlEl || !mainEl){
      console.warn('固定视图元素未加载完成，操作失效');
      return;
    }
    
    isViewsHidden = !isViewsHidden;
    
    if(isViewsHidden){
      // Hide fixed views
      headerEl.classList.add('hidden');
      scrollControlEl.classList.add('hidden');
      mainEl.classList.add('expanded');
      
      // Switch to floating button
      floatingToggleBtn.classList.add('visible');
      
      console.log('固定视图已隐藏');
    } else {
      // Show fixed views
      headerEl.classList.remove('hidden');
      scrollControlEl.classList.remove('hidden');
      mainEl.classList.remove('expanded');
      
      // Switch back to inline button
      floatingToggleBtn.classList.remove('visible');
      
      console.log('固定视图已恢复');
    }
    
    // Save state to localStorage
    localStorage.setItem('csv_views_hidden_v1', isViewsHidden);
    
    const responseTime = performance.now() - startTime;
    if(responseTime > 100){
      console.warn(`响应时间警告：视图切换耗时 ${responseTime.toFixed(2)}ms，超过 100ms 目标`);
    } else {
      console.log(`视图切换完成，耗时 ${responseTime.toFixed(2)}ms`);
    }
  }
  
  // Restore saved view state on page load
  function restoreViewState(){
    const savedState = localStorage.getItem('csv_views_hidden_v1');
    if(savedState === 'true'){
      // Apply hidden state without animation (instant)
      if(headerEl) headerEl.style.transition = 'none';
      if(scrollControlEl) scrollControlEl.style.transition = 'none';
      if(mainEl) mainEl.style.transition = 'none';
      
      isViewsHidden = false; // Set to false first so toggle will set to true
      toggleFixedViews();
      
      // Re-enable transitions after a frame
      requestAnimationFrame(()=>{
        if(headerEl) headerEl.style.transition = '';
        if(scrollControlEl) scrollControlEl.style.transition = '';
        if(mainEl) mainEl.style.transition = '';
      });
    }
  }
  
  // Call restore on page load
  restoreViewState();
  
  // Bind click events
  if(toggleViewBtn){
    toggleViewBtn.addEventListener('click', toggleFixedViews);
  }
  
  if(floatingToggleBtn){
    floatingToggleBtn.addEventListener('click', toggleFixedViews);
  }

  /* ---------- History management ---------- */
  function loadHistory(){return loadJSON(HISTORY_KEY,[])}
  function saveHistory(h){saveJSON(HISTORY_KEY,h)}
  function addHistory(name){let h=loadHistory(); if(!h.includes(name)){h.push(name); saveHistory(h)}}
  function removeHistory(name){let h=loadHistory(); h=h.filter(x=>x!==name); saveHistory(h)}

  function saveCsv(name,rows){saveJSON('csv_data_'+name,rows)}
  function loadCsv(name){return loadJSON('csv_data_'+name,null)}
  function saveRatings(name,ratings){saveJSON('csv_ratings_'+name,ratings)}
  function loadRatings(name){return loadJSON('csv_ratings_'+name,{} )}

  /* ---------- Render history dropdown ---------- */
  function renderHistory(){
    const h = loadHistory();
    historyList.innerHTML='';
    if(!h.length){historyList.innerHTML='<div class="small" style="padding:8px">无历史记录</div>';return}
    // show newest first
    h.slice().reverse().forEach(name=>{
      const it = document.createElement('div'); it.className='history-item';
      const left = document.createElement('div'); left.className='name'; left.textContent = name;
      const right = document.createElement('div');
      const loadBtn = document.createElement('button'); loadBtn.className='btn'; loadBtn.textContent='加载'; loadBtn.onclick=()=>{loadFromHistory(name); toggleHistory(false)};
      const delBtn = document.createElement('button'); delBtn.className='reset'; delBtn.textContent='删除'; delBtn.onclick=()=>{ if(confirm('从历史中删除 "'+name+'" ? （不会删除评分）')){ removeHistory(name); renderHistory(); }};
      right.appendChild(loadBtn); right.appendChild(delBtn);
      it.appendChild(left); it.appendChild(right);
      historyList.appendChild(it);
    })
  }

  function toggleHistory(show){ 
    if(show){
      historyList.style.display = 'block';
      renderHistory();
      
      // Calculate position dynamically
      const btnRect = historyBtn.getBoundingClientRect();
      const listRect = historyList.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;
      
      // Position below button
      let top = btnRect.bottom + 8;
      let left = btnRect.left;
      
      // Ensure at least 100px from left edge
      if(left < 100){
        left = 100;
      }
      
      // Ensure at least 100px from right edge
      if(left + listRect.width > viewportWidth - 100){
        left = viewportWidth - listRect.width - 100;
      }
      
      // Ensure doesn't overflow bottom
      if(top + listRect.height > viewportHeight - 20){
        top = btnRect.top - listRect.height - 8;
      }
      
      historyList.style.top = top + 'px';
      historyList.style.left = left + 'px';
    } else {
      historyList.style.display = 'none';
    }
  }
  
  historyBtn.addEventListener('click', e=>{ toggleHistory(historyList.style.display==='none'); });
  document.addEventListener('click', e=>{ if(!e.composedPath().includes(historyList) && e.target !== historyBtn) toggleHistory(false); })
  
  // Recalculate position on window resize
  window.addEventListener('resize', ()=>{ if(historyList.style.display === 'block') toggleHistory(true); })

  /* ---------- File input handling ---------- */
  fileInput.addEventListener('change', async e=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const text = await f.text();
    const parsed = parseCSV(text);
    const name = f.name;
    saveCsv(name, parsed);
    addHistory(name);
    loadFile(name, parsed);
  });

  function loadFromHistory(name){ const data = loadCsv(name); if(!data){ alert('历史中未保存该文件的内容，请重新上传'); return; } loadFile(name,data); }

  function loadFile(name,data){ currentFile = name; rows = data; ratings = loadRatings(name) || {}; renderCards(); }

  /* ---------- Scroll control functions ---------- */
  function updateScrollControls(){
    // Calculate total rows (excluding header)
    totalRows = rows && rows.length > 1 ? rows.length - 1 : 0;
    
    if(totalRows === 0){
      // Disable all controls
      scrollSlider.disabled = true;
      jumpInput.disabled = true;
      goBtn.disabled = true;
      scrollSlider.max = 1;
      scrollSlider.value = 1;
      rowInfo.textContent = '当前显示第 0 条 / 共 0 条';
      currentRowNum = 1;
    } else {
      // Enable controls
      scrollSlider.disabled = false;
      jumpInput.disabled = false;
      goBtn.disabled = false;
      scrollSlider.max = totalRows;
      jumpInput.max = totalRows;
      
      // Reset to first row
      currentRowNum = 1;
      scrollSlider.value = 1;
      jumpInput.value = '';
      updateRowInfo();
    }
  }
  
  function updateRowInfo(){
    rowInfo.textContent = `当前显示第 ${currentRowNum} 条 / 共 ${totalRows} 条`;
  }
  
  function scrollToRow(rowNum, forceImmediate = false){
    if(rowNum < 1 || rowNum > totalRows || !totalRows) return false;
    
    // Interrupt any ongoing scroll animation
    if(scrollAnimationId !== null){
      cancelAnimationFrame(scrollAnimationId);
      scrollAnimationId = null;
    }
    
    // Find card with matching original row index
    const targetCard = cardsEl.querySelector(`.card[data-row-index="${rowNum}"]`);
    if(!targetCard) return false;
    
    const startTime = performance.now();
    
    // Determine scroll behavior based on data size
    // For large datasets (>= 5000 rows), use instant jump for better performance
    const useInstantScroll = forceImmediate || totalRows >= 5000;
    
    // Update current state immediately for responsive UI
    currentRowNum = rowNum;
    scrollSlider.value = rowNum;
    updateRowInfo();
    
    if(useInstantScroll){
      // Instant jump without animation
      targetCard.scrollIntoView({ behavior: 'auto', block: 'start' });
      
      const scrollTime = performance.now() - startTime;
      console.log(`即时跳转到第 ${rowNum} 行，耗时 ${scrollTime.toFixed(2)}ms`);
      
      // Check if response time is within 100ms requirement
      if(scrollTime > 100){
        console.warn(`响应时间警告：即时跳转耗时 ${scrollTime.toFixed(2)}ms，超过 100ms 目标`);
      }
      
      return true;
    } else {
      // Smooth scroll with fixed 0.5s duration using custom animation
      const startPosition = window.pageYOffset;
      const targetPosition = targetCard.getBoundingClientRect().top + window.pageYOffset - 120;
      const distance = targetPosition - startPosition;
      const duration = 500; // Fixed 500ms animation
      let startTimestamp = null;
      
      function animateScroll(timestamp){
        if(!startTimestamp) startTimestamp = timestamp;
        const elapsed = timestamp - startTimestamp;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function (ease-in-out)
        const easeInOutCubic = progress < 0.5
          ? 4 * progress * progress * progress
          : 1 - Math.pow(-2 * progress + 2, 3) / 2;
        
        window.scrollTo(0, startPosition + distance * easeInOutCubic);
        
        if(progress < 1){
          scrollAnimationId = requestAnimationFrame(animateScroll);
        } else {
          scrollAnimationId = null;
          const scrollTime = performance.now() - startTime;
          console.log(`平滑滚动到第 ${rowNum} 行，总耗时 ${scrollTime.toFixed(2)}ms`);
        }
      }
      
      // Check initial response time (should start animation within 100ms)
      const responseTime = performance.now() - startTime;
      if(responseTime > 100){
        console.warn(`响应时间警告：动画启动耗时 ${responseTime.toFixed(2)}ms，超过 100ms 目标`);
      }
      
      scrollAnimationId = requestAnimationFrame(animateScroll);
      
      return true;
    }
  }
  
  // Slider events
  // Update display while dragging (no scroll)
  scrollSlider.addEventListener('input', function(){
    const rowNum = parseInt(this.value);
    currentRowNum = rowNum;
    updateRowInfo();
  });
  
  // Scroll when released
  scrollSlider.addEventListener('change', function(){
    const rowNum = parseInt(this.value);
    scrollToRow(rowNum);
  });
  
  // Jump input validation
  jumpInput.addEventListener('input', function(){
    this.classList.remove('error');
    // Only allow positive integers
    this.value = this.value.replace(/[^\d]/g, '');
  });
  
  // Go button click
  goBtn.addEventListener('click', function(){
    const inputValue = jumpInput.value.trim();
    if(!inputValue){
      jumpInput.classList.add('error');
      return;
    }
    
    const rowNum = parseInt(inputValue);
    
    if(isNaN(rowNum) || rowNum < 1 || rowNum > totalRows){
      jumpInput.classList.add('error');
      console.warn(`行号超出范围：${rowNum}，有效范围 1-${totalRows}`);
      return;
    }
    
    jumpInput.classList.remove('error');
    scrollToRow(rowNum);
  });
  
  // Allow Enter key in jump input
  jumpInput.addEventListener('keypress', function(e){
    if(e.key === 'Enter'){
      goBtn.click();
    }
  });
  
  // Track scroll position and update slider/row info accordingly
  let scrollTimeout;
  window.addEventListener('scroll', function(){
    if(totalRows === 0) return;
    
    // Don't update during programmatic scroll animation
    if(scrollAnimationId !== null) return;
    
    // Debounce scroll event for performance
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function(){
      // Skip if animation is running
      if(scrollAnimationId !== null) return;
      
      // Find the first visible card
      const cards = cardsEl.querySelectorAll('.card');
      let visibleCard = null;
      
      for(let card of cards){
        const rect = card.getBoundingClientRect();
        // Check if card is in viewport (below the fixed headers)
        if(rect.top >= 150 && rect.top <= window.innerHeight / 2){
          visibleCard = card;
          break;
        }
      }
      
      if(visibleCard){
        const rowIndex = parseInt(visibleCard.dataset.rowIndex);
        if(rowIndex && rowIndex !== currentRowNum){
          currentRowNum = rowIndex;
          scrollSlider.value = rowIndex;
          updateRowInfo();
        }
      }
    }, 150);
  });

  /* ---------- Rendering cards ---------- */
  function renderCards(){
    const startTime = performance.now();
    cardsEl.innerHTML='';
    if(!rows || !rows.length){ 
      emptyEl.style.display='block'; 
      updateScrollControls(); // Update controls to disabled state
      return; 
    } else {
      emptyEl.style.display='none';
    }

    // Skip first row (header) if exists
    const dataRows = rows.length > 1 ? rows.slice(1) : rows;

    // Build items: for each CSV row -> card. Each field displayed in its own row.
    const items = dataRows.map((r,idx)=>({
      idx, row:r, id: rowId(currentFile||'nofile', r)
    }));

    // ensure ratings default
    items.forEach(it=>{ if(ratings[it.id]===undefined) ratings[it.id]=0; });

    // sort by rating desc, then idx
    items.sort((a,b)=> (ratings[b.id]||0)-(ratings[a.id]||0) || a.idx-b.idx );

    // Use DocumentFragment for better performance
    const fragment = document.createDocumentFragment();

    items.forEach(it=>{
      const card = document.createElement('div'); card.className='card';
      card.dataset.rowIndex = it.idx + 1; // Store original row number (1-based)
      
      // left: content
      const body = document.createElement('div'); body.className='card-body';
      
      // Helper function to get cell value with fallback
      const getCell = (index) => {
        const val = it.row[index];
        if(val === undefined || val === null || val === ''){
          console.warn(`CSV数据异常：第${it.idx+1}行第${index+1}列数据缺失`);
          return '—';
        }
        return val;
      };

      // Row header: row number (left) + first column value (right)
      const header = document.createElement('div'); header.className='row-header';
      const rowNum = document.createElement('div'); rowNum.className='row-number'; rowNum.textContent = `#${it.idx + 1}`;
      const colFirst = document.createElement('div'); colFirst.className='col-first'; colFirst.textContent = getCell(0);
      header.appendChild(rowNum); header.appendChild(colFirst);
      body.appendChild(header);

      // Columns 2 & 3 on same line with 4 spaces
      if(it.row.length > 1){
        const cols23 = document.createElement('div'); cols23.className='cols-23';
        const col2 = getCell(1);
        const col3 = it.row.length > 2 ? getCell(2) : '';
        cols23.textContent = col3 ? `${col2}    ${col3}` : col2;
        body.appendChild(cols23);
      }

      // Remaining columns (4+)
      for(let i=3; i<it.row.length; i++){
        const fld = document.createElement('div'); fld.className='field'; fld.textContent = getCell(i);
        body.appendChild(fld);
      }

      // right: stars
      const side = document.createElement('div'); side.className='card-side';
      const starsWrap = document.createElement('div'); starsWrap.className='stars';
      const cur = ratings[it.id] || 0;
      for(let s=1;s<=5;s++){
        const sp = document.createElement('span'); sp.className='star' + (s<=cur? ' active':''); sp.textContent='★'; sp.dataset.value = s;
        sp.title = s + ' 星';
        sp.addEventListener('click', ()=>{ setRating(it.id,s); });
        starsWrap.appendChild(sp);
      }
      // allow clicking empty area to set 0
      const zero = document.createElement('div'); zero.className='small'; zero.style.cursor='pointer'; zero.style.marginTop='4px'; zero.textContent='取消'; zero.addEventListener('click', ()=>{ if(confirm('确认要将该项评分重置为 0 吗？')) setRating(it.id,0); });
      side.appendChild(starsWrap); side.appendChild(zero);

      card.appendChild(body); card.appendChild(side);
      fragment.appendChild(card);
    });

    // Batch insert all cards at once for better performance
    cardsEl.appendChild(fragment);

    // persist ratings immediately
    if(currentFile) saveRatings(currentFile, ratings);

    // Performance logging
    const renderTime = performance.now() - startTime;
    console.log(`渲染完成：${items.length} 条数据，耗时 ${renderTime.toFixed(2)}ms`);
    if(renderTime > 200 && items.length >= 1000){
      console.warn(`性能警告：渲染 ${items.length} 条数据耗时超过 200ms`);
    }
    
    // Update scroll controls after rendering
    updateScrollControls();
  }

  function setRating(id,val){ ratings[id]=val; if(currentFile) saveRatings(currentFile,ratings); renderCards(); }

  /* ---------- Load last opened file on start if exists ---------- */
  (function init(){
    const h = loadHistory();
    if(h && h.length){ const last = h[h.length-1]; const data = loadCsv(last); if(data){ loadFile(last,data); }}
  })();

  /* ---------- Background switching (color blocks) ---------- */
  const sw0 = document.getElementById('sw0');
  const sw1 = document.getElementById('sw1');
  const sw2 = document.getElementById('sw2');
  const sw3 = document.getElementById('sw3');

  function applyTheme(index){
    if(index===0){ document.body.style.background='linear-gradient(135deg,#4A90E2,#9013FE)'; document.body.style.backgroundAttachment='fixed'; document.body.style.color='var(--text-light)'; }
    if(index===1){ document.body.style.background='#ffffff'; document.body.style.backgroundAttachment='fixed'; document.body.style.color='var(--text-dark)'; }
    if(index===2){ document.body.style.background='#e5e7eb'; document.body.style.backgroundAttachment='fixed'; document.body.style.color='var(--text-dark)'; }
    if(index===3){ document.body.style.background='#0f172a'; document.body.style.backgroundAttachment='fixed'; document.body.style.color='var(--text-light)'; }
    // adjust CSS variables for cards readability
    const isLight = (index===1||index===2);
    document.documentElement.style.setProperty('--card-bg', isLight? 'rgba(255,255,255,0.9)': 'rgba(0,0,0,0.36)');
    document.documentElement.style.setProperty('--muted', isLight? '#4b5563':'#9aa4b2');
    
    // Update scroll control colors for light/dark theme
    const scrollControl = document.querySelector('.scroll-control');
    const header = document.querySelector('header');
    const toggleViewBtnEl = document.getElementById('toggleViewBtn');
    const floatingToggleBtnEl = document.getElementById('floatingToggleBtn');
    
    if(isLight){
      header.style.background = 'rgba(255,255,255,0.85)';
      scrollControl.style.background = 'rgba(255,255,255,0.75)';
      rowInfo.style.color = '#0f172a';
      jumpInput.style.color = '#0f172a';
      jumpInput.style.background = 'rgba(0,0,0,0.05)';
      jumpInput.style.borderColor = 'rgba(0,0,0,0.15)';
      
      // Update toggle buttons for light theme
      if(toggleViewBtnEl){
        toggleViewBtnEl.style.background = 'rgba(0,0,0,0.08)';
        toggleViewBtnEl.style.color = '#0f172a';
        toggleViewBtnEl.style.borderColor = 'rgba(0,0,0,0.15)';
      }
      if(floatingToggleBtnEl){
        floatingToggleBtnEl.style.background = 'rgba(255,255,255,0.9)';
        floatingToggleBtnEl.style.color = '#0f172a';
        floatingToggleBtnEl.style.borderColor = 'rgba(0,0,0,0.2)';
      }
    } else {
      header.style.background = 'rgba(0,0,0,0.25)';
      scrollControl.style.background = 'rgba(0,0,0,0.2)';
      rowInfo.style.color = '#fff';
      jumpInput.style.color = '#fff';
      jumpInput.style.background = 'rgba(255,255,255,0.1)';
      jumpInput.style.borderColor = 'rgba(255,255,255,0.2)';
      
      // Update toggle buttons for dark theme
      if(toggleViewBtnEl){
        toggleViewBtnEl.style.background = 'rgba(255,255,255,0.15)';
        toggleViewBtnEl.style.color = '#fff';
        toggleViewBtnEl.style.borderColor = 'rgba(255,255,255,0.2)';
      }
      if(floatingToggleBtnEl){
        floatingToggleBtnEl.style.background = 'rgba(0,0,0,0.6)';
        floatingToggleBtnEl.style.color = '#fff';
        floatingToggleBtnEl.style.borderColor = 'rgba(255,255,255,0.3)';
      }
    }
    
    // force re-render to update text colors in cards
    renderCards();
    // save theme
    localStorage.setItem('csv_theme_v1', index);
  }
  sw0.addEventListener('click', ()=>applyTheme(0));
  sw1.addEventListener('click', ()=>applyTheme(1));
  sw2.addEventListener('click', ()=>applyTheme(2));
  sw3.addEventListener('click', ()=>applyTheme(3));

  // restore saved theme
  const savedTheme = localStorage.getItem('csv_theme_v1'); if(savedTheme!==null) applyTheme(Number(savedTheme));

  /* ---------- utility save/load wrapper ---------- */
  function saveRatings(name, obj){ saveJSON('csv_ratings_'+name, obj); }
  function loadRatings(name){ return loadJSON('csv_ratings_'+name, {} ); }

</script>
</body>
</html>